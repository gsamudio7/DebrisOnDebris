
# Imports ####
rm(list=ls())
library(data.table)
library(dplyr)
library(repmis)
library(stringr)
library(plotly)
library(RColorBrewer)
library(tidyr)

# Source functions
source("scripts/supportFunctions.R")

# Loads data directly from dropbox
dropBoxURL <- "https://www.dropbox.com/s/4si129wa5kou67i/DebrisOnDebris3.csv?dl=0"
debrisInfo <- downloadFromDropBox(dropbox_csv_url=dropBoxURL) %>%

  # Process data to make it useable
  processDebris()

# Save processed data to be read in easily when knitting the Rmd
save(debrisInfo,file="data/debrisInfo.RData")

# Prob of Collision within 1 day to TCA
Pc_at_1_day <- 
suppressWarnings(
  debrisInfo$data[,c("fragLabel","1")] %>%
  plot_ly(
    type="box",
    y=~log(`1`),
    color=~fragLabel,
    colors=colorRampPalette(c("dodgerblue","orange"))(5),
    showlegend=FALSE,
    hoverinfo="text",
    boxpoints = "all",
    jitter = 0.75,
    marker=list(size=3,opacity=0.75,symbol="-"),
    pointpos = -2) %>%
    
    add_trace(
      data=debrisInfo$concernProbs,
      type="scatter",
      mode="markers",
      x=~fragLabel,
      y=~log(`.75 Superquantile`),
      marker=list(size=15,color="red",symbol="octagon-open",line=list(width=2)),
      text = ~paste0("<b>.75 Superquantile: </b>",`.75 Superquantile` %>%
                       format(format="e",digits=2))) %>%
        
  layout(yaxis = list(title="<b>Collision Probability</b>",
                      tickvals = seq(-22,-8,2),
                      ticktext = seq(-22,-8,2) %>% exp() %>% formatC(format="e",digits=2),
                      gridcolor="#222222"),
         xaxis = list(title=""),
         legend = list(title = list(text = "<b>Fragment Size</b>")),
         plot_bgcolor  = "#333333",
         paper_bgcolor = "#333333",
         font = list(color = '#FFFFFF'))
) %>% plotly_build()
    
# Save
save(Pc_at_1_day,file="products/Pc_at_1_day.RData")



# Plot Pc collision differences as we appraoach TCA ####
debrisInfo$data[is.na(debrisInfo$data)] <- 0 
deltaFrame <- purrr::map_dfr(
  .x=c("5","4","3"),
  .f=function(i) {
    data.table("delta"=debrisInfo$data[,`1`] - debrisInfo$data[[i]],
               "TCA_Bin"=i)
  }
)
deltaFrame[deltaFrame==0] <- 1e-100

Pc_delta <- 
  deltaFrame %>%
  plot_ly(
    type="histogram",
    x=~delta,
    color=~TCA_Bin,
    nbinsx=20,
    colors=colorRampPalette(c("dodgerblue","orange"))(5)
  ) %>%
  layout(xaxis = list(title="<b>Collision Probability Delta\nOver time</b>",
                      gridcolor="#222222",
                      tickvals=seq(-600*1e-6,400*1e-6,200*1e-6),
                      ticktext=seq(-600*1e-6,400*1e-6,200*1e-6) %>% 
                        formatC(format="e",digits=0)),
         
         yaxis = list(title="<b>Frequency</b>",
                      gridcolor="#222222",
                      type = "log"),
         legend = list(title = list(text = "<b>Days to TCA</b>")),
         plot_bgcolor  = "#333333",
         paper_bgcolor = "#333333",
         font = list(color = '#FFFFFF')
  ) %>% plotly_build()

save(Pc_delta,file="products/Pc_delta.RData")


