# Imports ####

library(data.table)
library(dplyr)
library(plotly)
library(RColorBrewer)

load("data/concernData.RData")

# How does quantity change over time ####
concernSummary_at_TOI[fragNum=="PcBest" & Pc_at_TOI >= 1e-5,.N,by=TCA_Bin] %>% 
  plot_ly(
    type="bar",
    x=~TCA_Bin,
    y=~N,
    color=I("royalblue4")
  )




# How does quantity of NEW concern events change over time
concernEvents <- concernSummary_at_TOI[fragNum=="PcBest" & Pc_at_TOI >= 1e-5]

newConcernEvents <- list("10"=concernEvents[TCA_Bin==10,unique(eventNumber)])
for (i in (9:1)) {
  oldEvents <- concernEvents[TCA_Bin==i + 1,unique(eventNumber)] 
  newEvents <- concernEvents[TCA_Bin==i,unique(eventNumber)] 
  newConcernEvents[[as.character(i)]] = setdiff(newEvents,oldEvents)
}
newConcernSummary <- merge(
  data.table("TCA_Bin"=as.factor(10:1),
             "newCount"=unlist(lapply(newConcernEvents,length))),
  concernEvents[,.(concernCount=.N),by=TCA_Bin],
  by="TCA_Bin"
) 

newConcernSummary_plot <- newConcernSummary %>% 
  plot_ly(
    type="bar",
    x=~TCA_Bin,
    y=~concernCount,
    color=I("#222222"),
    name="Total",
    hoverinfo="none"
  ) %>%
  
  add_trace(
    y=~newCount,
    name="New",
    color=I("#2359c4")
  ) %>%
  
  layout(
    xaxis=list(title="<b>Days to TCA Bin</b>",
               gridcolor="#333333"),
    yaxis=list(title="<b>Concern Events</b>",
               gridcolor="#333333"),
    plot_bgcolor  = "#444444",
    paper_bgcolor = "#444444",
    font = list(color = '#FFFFFF')
  )



save(newConcernSummary_plot,file="products/newConcernSummary_plot.RData")


# Count the number of new events plus events that are carried through
'%ni%' <- Negate('%in%')
events_at_5 <- concernSummary_at_TOI[TCA_Bin==5,unique(eventNumber)]
length(events_at_5)
events_at_5_and_1 <- concernSummary_at_TOI[eventNumber %in% events_at_5 & TCA_Bin==1,unique(eventNumber)]
length(events_at_5_and_1)
events_at_1_and_not_at_5 <- concernSummary_at_TOI[eventNumber %ni% events_at_5 & TCA_Bin==1,
                                                  unique(eventNumber)]
length(events_at_1_and_not_at_5)
events_at_5_and_not_at_1 <- setdiff(events_at_5,concernSummary[,unique(eventNumber)])

# Verify
length(events_at_5_and_1) + length(events_at_1_and_not_at_5) == concernSummary_at_TOI[TCA_Bin==1,uniqueN(eventNumber)]

# Wrangle data to show
## event PC at 5 / PC at 1 / makes it through (Y/N)
deltaSummary <- rbindlist(list(
  concernSummary_at_TOI[eventNumber %in% events_at_5_and_1 &
                          fragNum=="PcBest" &
                          TCA_Bin==5, .(eventNumber,TCA_Bin,Pc=Pc_at_TOI,Censored=FALSE)],
  concernSummary[eventNumber %in% events_at_5_and_1 &
                   fragNum=="PcBest", .(eventNumber,TCA_Bin=1,Pc=Pc_min,Censored=FALSE)],
  concernSummary_at_TOI[eventNumber %in% events_at_5_and_not_at_1 &
                          fragNum=="PcBest" &
                          TCA_Bin==5, .(eventNumber,TCA_Bin,Pc=Pc_at_TOI,Censored=TRUE)],
  data.table("eventNumber"=events_at_5_and_not_at_1,
             "TCA_Bin"=1,
             "Pc"=0,
             "Censored"=TRUE)
))
setorder(deltaSummary,-"TCA_Bin")
delta_plot_summary <- deltaSummary[,.(delta=diff(Pc)),by=c("eventNumber","Censored")] 



delta_plot_summary[,"Delta" := ifelse(delta > 0, "> 0",
                                      ifelse(delta == 0, "= 0","< 0"))]


deltaCountSummary <- merge(
  data.table("Total"=c(delta_plot_summary[Censored==TRUE,.N],
                       delta_plot_summary[Censored==FALSE,.N]),
             "Censored"=c(TRUE,FALSE)
  ),
  
  delta_plot_summary[,.(Count=.N),by=c("Censored","Delta")],
  by="Censored"
)
deltaCountSummary[,"Proportion" := round(Count/Total,3)]
deltaCountSummary[,!"Total"]

delta_plot_summary %>%
  plot_ly(
    type="histogram",
    x=~delta,
    nbinsx=10,
    color=~Censored
  ) %>%
  layout(
    xaxis = list(title="<b>Collision Probability Delta\nat 5 and 1 days to TCA</b>",
                 tickvals = seq(-700,0,100),
                 ticktext = seq(-700,0,100) %>% exp() %>% formatC(format="e",digits=2),
                 tickfont = list(size = 10),
                 gridcolor="#333333"))


# What is the distribution of Pc at 5 for events that make it to 1
concernSummary_at_TOI[fragNum=="PcBest" & 
                        eventNumber %in% events_at_5_and_1 & 
                        TCA_Bin == 5 |
                        
                        fragNum=="PcBest" & 
                        eventNumber %in% events_at_5_and_1 & 
                        TCA_Bin == 1] %>%
  plot_ly(
    type="box",
    x=~TCA_Bin,
    y=~log(Pc_at_TOI)
  ) 

# What is the distribution of the delta?
concernSummary_Pc_at_1_from_5 <- concernSummary_at_TOI[
  fragNum=="PcBest" & 
    eventNumber %in% events_at_5_and_1 & 
    TCA_Bin == 1 |
    
    fragNum=="PcBest" & 
    eventNumber %in% events_at_5_and_1 & 
    TCA_Bin == 5] %>% setorder(eventNumber,-TCA_Bin)

concernSummary_diff_at_1_from_5 <- concernSummary_Pc_at_1_from_5[
  ,.(Delta=diff(Pc_at_TOI)),by=eventNumber] 

# How many 0
concernSummary_diff_at_1_from_5[Delta==0,.N]/concernSummary_diff_at_1_from_5[,.N] # 0.64

# How many increased
concernSummary_diff_at_1_from_5[Delta > 0,.N]/concernSummary_diff_at_1_from_5[,.N] # 0.085

# How many decreased
concernSummary_diff_at_1_from_5[Delta < 0,.N]/concernSummary_diff_at_1_from_5[,.N] 

# Box Plot
concernSummary_Pc_at_1_from_5 %>%
  plot_ly(
    type="box",
    y=~log(Pc_at_TOI),
    x=~as.integer(TCA_Bin) - 1
  ) %>%
  layout(
    yaxis = list(title="<b>Probability of Collision</b>",
                 tickvals = seq(-700,0,100),
                 ticktext = seq(-700,0,100) %>% exp() %>% formatC(format="e",digits=2),
                 tickfont = list(size = 10)),
    xaxis = list(title="<b>Days to TCA</b>")
  )

concernSummary_Pc_at_1_from_5 %>%
  plot_ly(
    type="scatter",
    mode="lines",
    y=~log(Pc_at_TOI),
    x=~as.integer(TCA_Bin) - 1
  ) 

# Conclusion
## No obvious advantage in having a higher Pc_warn threshold at 5 days than the Pc_concern rate

# Question remains, what Pc_warn value at 5 days is the ideal to use to 
## minimize False negatives and minimize False Positives




# Plot
Pc_by_TCA_plot <- 
  
concernSummary_at_TOI[fragNum=="PcBest"] %>%
  plot_ly(
    type="box",
    y=~log(Pc_at_TOI),
    x=~TCA_Bin,
    hoverinfo="none",
    color=I("#2359c4")
  ) %>%
  layout(
    yaxis = list(title="<b>Collision Probability</b>",
                 tickvals = seq(-30,-6,2),
                 ticktext = seq(-30,-6,2) %>% exp() %>% formatC(format="e",digits=2),
                 tickfont = list(size = 10),
                 gridcolor="#333333"),
    xaxis = list(title="<b>Days to TCA</b>",
                 gridcolor="#333333"),
    plot_bgcolor  = "#444444",
    paper_bgcolor = "#444444",
    font = list(color = '#FFFFFF')
  )

save(Pc_by_TCA_plot,file="products/Pc_by_TCA_plot.RData")



# Count total positives (events of concern) that we have visibility on at 5 days out
Pc_concern <- 1e-5
(P_at_5 <- concernSummary_at_TOI[TCA_Bin==5 & PcBest_at_TOI >= Pc_concern,.N]) # 21
(N_at_5 <- concernSummary_at_TOI[TCA_Bin==5 & PcBest_at_TOI < Pc_concern,.N]) # 29323

(P <- concernSummary[fragNum=="PcBest" & Pc_min >= Pc_concern,.N]) # 58
(N <- concernSummary[fragNum=="PcBest" & Pc_min < Pc_concern,.N]) # 48193


# Imports for plot ####
library(data.table)
library(dplyr)
library(plotly)
library(RColorBrewer)

# Loads two data sets, concernSummary and concernSummary_at_TOI (time of interest)
load("data/concernData.RData")

# Prepare data
debrisData <- merge(
  concernData_at_TOI[TCA_Bin==days_to_TCA,c("eventNumber","Pc_at_TOI","fragNum")],
  concernData[,c("eventNumber","Pc_min","fragNum")],
  by=c("eventNumber","fragNum")
)

# Sample
sampleEvents <- sample(df[,unique(eventNumber)],360,replace=TRUE)
sampleDebris <- debrisData[eventNumber %in% sampleEvents]

# Debris Confusion Function ####
debrisConfusion <- function(df,
                            Pc_warn,
                            days_to_TCA,
                            Pc_concern=1e-5,
                            fragVector=c("PcBest","PcFrag10","PcFrag100"),
                            verbose=FALSE
                            ) {
  
  # Initiate result list
  result <- list()
  
  # Loop over frag numbers
  for (frag in fragVector) {
    
    # Count missed events (FN) and false alarms (FP) and warnings
    # Accumulate in a data.table
    result[[paste0(frag)]] <- data.table(
      "WarnThreshold"=Pc_warn %>% formatC(format="e",digits=2),
      "Missed"=df[fragNum==frag & Pc_at_TOI < Pc_warn & Pc_min >= Pc_concern,.N],
      "FalseAlarms"=df[fragNum==frag & Pc_at_TOI >= Pc_warn & Pc_min < Pc_concern,.N],
      "WarningCount"=df[fragNum==frag & Pc_at_TOI >= Pc_warn,.N],
      "FragmentSize"=frag
    )
  }
  return(rbindlist(result))
}

# Get data for a range of values ####
concernCount <- purrr::map(
  seq(from=1e-7,to=1e-5,by=1e-6),
  debrisConfusion,
  df=sampleDebris,
  days_to_TCA=5) %>% rbindlist() 

# Make Concern Prob and Frag size factors
fragLabel <- case_when(
  concernCount[,FragmentSize] == "PcBest" ~ ">= 1",
  concernCount[,FragmentSize] == "PcFrag10" ~ ">= 10",
  concernCount[,FragmentSize] == "PcFrag100" ~ ">= 100"
)
concernCount[,"FragLabel" := fragLabel]

# FP against FN plot ####
#concernCount_plot <- 
  concernCount %>% 
  plot_ly(type="scatter",
          mode="lines",
          x=~FalseAlarms,
          y=~Missed,
          color=~FragLabel,
          text=~paste0("<b>Warning Threshold: </b>",WarnThreshold,"<br>",
                       "<b>Missed Concern Events: </b>",Missed,"<br>",
                       "<b>False Alarms: </b>",FalseAlarms,"<br>",
                       "<b>Warning Count: </b>",WarningCount,"<br>"),
          hoverinfo="text",
          colors=c("yellow","orange","#990000"),
          line=list(width=3.5)
  ) %>%
  
  layout(
    xaxis = list(title="<b>False Alarms (FP)</b>",
                 gridcolor="#333333"
    ),
    yaxis = list(title="<b>Missed Concern Events (FN)</b>",
                 gridcolor="#333333",
                 zeroline = TRUE,
                 zerolinecolor="#333333"),
    plot_bgcolor  = "#444444",
    paper_bgcolor = "#444444",
    font = list(color = '#FFFFFF')
  )

save(concernCount_plot,file="products/concernRates_plot.RData")
# Function Demo ####

# Test 
rm(list=ls())

# Read in required data 
load("data/concernData.RData")

# Read in debrisCounfuction function
source("scripts/debrisConfusion.R")

# Execute function for the following inputs
results <- debrisConfusion(concernData_at_TOI=concernSummary_at_TOI,
                           concernData=concernSummary,
                           Pc_warn=2.06e-9,
                           days_to_TCA=5,
                           Pc_concern=1e-5,
                           frag_number_Pc="PcBest",
                           verbose=FALSE,
                           rate=FALSE)
