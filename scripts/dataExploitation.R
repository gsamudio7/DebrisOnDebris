
# Imports ####
rm(list=ls())
library(data.table)
library(dplyr)
library(plotly)
library(RColorBrewer)

# Loads two data sets, concernSummary and concernSummary_at_TOI (time of interest)
load("data/debrisData.RData")
events <- fread("data/events.csv")
(scale <- 365/events[,uniqueN(round(time_of_screening))])

# Debris Confusion Function ####
debrisConfusion <- function(df,
                            Pc_warn,
                            Pc_concern=1e-5,
                            fragVector=debrisData[,unique(fragLabel)],
                            verbose=FALSE
) {
  
  # Initiate result list
  result <- list()
  
  # Loop over frag numbers
  for (frag in fragVector) {
    
    # Count missed events (FN) and false alarms (FP) and warnings
    # Accumulate in a data.table
    result[[paste0(frag)]] <- data.table(
      "WarnThreshold"=Pc_warn %>% formatC(format="e",digits=2),
      "Missed"=round(df[fragLabel==frag & Pc_at_TOI < Pc_warn & Pc_min >= Pc_concern,.N]*scale),
      "FalseAlarms"=round(df[fragLabel==frag & Pc_at_TOI >= Pc_warn & Pc_min < Pc_concern,.N]*scale),
      "WarningCount"=round(df[fragLabel==frag & Pc_at_TOI >= Pc_warn,.N]*scale),
      "fragLabel"=frag,
      "TCA_Bin"=df[,unique(TCA_Bin)]
    )
  }
  return(rbindlist(result))
}

# Trade off plot function
trade_off_plot <- function(tcaBins=c(5),
                           test_thresholds=c(seq(from=1e-8,to=1e-5,by=1e-8),1e-5),
                           runMonte=FALSE,
                           numSamples=NULL,
                           weightMissed=2) {
  
  # Compute point estimate
  cat("\nComputing point estimates")
  concernCount <- purrr::map(
    test_thresholds,
    debrisConfusion,
    df=debrisData[TCA_Bin %in% tcaBins]) %>% rbindlist() 
  
  # Compute optimal thresholds 
  cat("\nComputing optimal thresholds")
  optimal_thresholds <- lapply(
    concernCount[,unique(fragLabel)],
    function(x) {concernCount[fragLabel==x][
      which.min(scale(Missed)*weightMissed + scale(FalseAlarms)),
      c("WarnThreshold","Missed","FalseAlarms","fragLabel","WarningCount","TCA_Bin")]}
  ) %>% rbindlist()
  
  # Monte Carlo
  if (runMonte==TRUE) {
    cat("\nSampling")
    debrisResult <- list()
    for (i in 1:numSamples) {
    
      # Sample the data
      sampleDebris <- debrisData[TCA_Bin %in% tcaBins][
        sample(.N,nrow(debrisData[TCA_Bin %in% tcaBins]),replace=TRUE)]  
    
      # Store results
      debrisResult[[i]] <- purrr::map(
        test_thresholds,
        debrisConfusion,
        df=sampleDebris) %>% rbindlist() 
  }
  
      # Get the 95% CI for FalseAlarms and Missed
      mcResult <- debrisResult %>% rbindlist()
      mcResult <- mcResult[,.(FalseAlarmHigh=quantile(FalseAlarms,.975),
                              FalseAlarmLow=quantile(FalseAlarms,.025),
                              MissedHigh=quantile(Missed,.975),
                              MissedLow=quantile(Missed,.025)),by=c("WarnThreshold",
                                                                    "fragLabel")]
  
      # Label the warning, false alarm, and missed count columns
      mcResult <- mcResult %>% 
        cbind(concernCount[,c("WarningCount","Missed","FalseAlarms")])
  }
  
  # FP against FN plot ####
  cat("\nPlotting\n")
  trade_off <- 
    concernCount %>% 
      plot_ly(type="scatter",
              mode="lines",
              x=~FalseAlarms,
              y=~Missed,
              color=~fragLabel,
              legendgroup=~fragLabel,
              text=~paste0("<b>Warning Threshold: </b>",WarnThreshold,"<br>",
                           "<b>Warning Count: </b>",round(WarningCount),"<br>",
                           "<b>Missed: </b>",round(Missed),"<br>",
                           "<b>False Alarms: </b>",round(FalseAlarms),"<br>"),
              hoverinfo="text",
              colors=c("blue","dodgerblue","gray"),
              line=list(width=3.25)
      ) %>%
      
      layout(
        legend = list(title = list(text="<b>Fragment Size</b>")),
        xaxis = list(title="<b>False Alarms (FP)</b>",
                     gridcolor="#333333"),
        yaxis = list(title="<b>Missed Concern Events (FN)</b>",
                     gridcolor="#333333",
                     zeroline = TRUE,
                     zerolinecolor="#333333"),
        plot_bgcolor  = "#444444",
        paper_bgcolor = "#444444",
        font = list(color = '#FFFFFF')
      ) %>%
      
      add_trace(
        data=optimal_thresholds,
        type="scatter",
        mode="markers+lines",
        marker=list(size=15,
                    color = 'rgba(17, 157, 255,0)',
                    line=list(color="mediumspringgreen",
                              width=3.25)),
        x=~FalseAlarms,
        y=~Missed,
        color='rgba(17, 157, 255,0)',
        line=list(color='rgba(17, 157, 255,0)'),
        name=paste0(sprintf(
          "Optimal Warning\nMissed weight: %s:1",weightMissed)),
        showlegend=TRUE
      )
  
  if (runMonte==FALSE) {return(
    list("plot"=trade_off %>% plotly_build(),
         "optThresholds"=optimal_thresholds))} else {
           
      trade_off <- 
      trade_off %>%
      add_trace(
        data=mcResult,
        type="scatter",
        mode="lines",
        line=list(dash=3,width=2),
        x=~FalseAlarmHigh,
        y=~MissedHigh,
        color=~fragLabel,
        legendgroup=~fragLabel,
        colors=c("blue","dodgerblue","gray"),
        showlegend=FALSE
      ) %>% 
      
      add_trace(
        data=mcResult,
        type="scatter",
        mode="lines",
        line=list(dash=3,width=2),
        x=~FalseAlarmLow,
        y=~MissedLow,
        color=~fragLabel,
        legendgroup=~fragLabel,
        colors=c("#2359c4","dodgerblue","gray"),
        showlegend=FALSE
      ) %>% plotly_build()
      
      return(
        list("plot"=trade_off,
             "optThresholds"=optimal_thresholds))}
}

# Find the optimal warningThreshold for 5,4,3 days to TCA
concernCount_5 <- trade_off_plot(weightMissed=1)
concernCount_4 <- trade_off_plot(tcaBins=c(4),weightMissed=1)
concernCount_3 <- trade_off_plot(tcaBins=c(3),weightMissed=1)

# Evaluate function
evalPerformance <- function(
  numSamples=1000,
  optimalThresholdList=list(
      concernCount_5$optThresholds,
      concernCount_4$optThresholds,
      concernCount_3$optThresholds
)) {

  # Aggregate point estimates over 3,4,5
  agg <- rbindlist(optimalThresholdList)
  aggData <- agg[,.(aggMissed=sum(Missed),
                    aggFalseAlarms=sum(FalseAlarms),
                    aggWarnings=sum(WarningCount)),by=fragLabel]

  # Run monte carlo using the optimal thresholds ####
  aggSim <- data.table()
  for (i in 1:numSamples) {
  
    # Sample and compute false alarm and missed with optimal warning thresholds 
    aggMonte <- rbindlist(list(
      lapply(1:3,function(j) {
        debrisConfusion(
          df=debrisData[TCA_Bin == 5][sample(.N,nrow(debrisData[TCA_Bin == 5]),replace=TRUE)],
          Pc_warn=concernCount_5$optThresholds$WarnThreshold[j] %>% as.numeric(),
          fragVector=concernCount_5$optThresholds$fragLabel[j])
      }) %>% rbindlist(),
    
      lapply(1:3,function(j) {
        debrisConfusion(
          df=debrisData[TCA_Bin == 4][sample(.N,nrow(debrisData[TCA_Bin == 4]),replace=TRUE)],
          Pc_warn=concernCount_4$optThresholds$WarnThreshold[j] %>% as.numeric(),
          fragVector=concernCount_4$optThresholds$fragLabel[j])
      }) %>% rbindlist(),
    
      lapply(1:3,function(j) {
        debrisConfusion(
          df=debrisData[TCA_Bin == 3][sample(.N,nrow(debrisData[TCA_Bin == 3]),replace=TRUE)],
          Pc_warn=concernCount_3$optThresholds$WarnThreshold[j] %>% as.numeric(),
          fragVector=concernCount_3$optThresholds$fragLabel[j])
      }) %>% rbindlist()
    ))

    # Organize results
    aggSim <- rbindlist(list(aggSim,
      aggMonte[,.(aggMissed=sum(Missed),
                  aggFalseAlarms=sum(FalseAlarms),
                  aggWarnings=sum(WarningCount)),by=fragLabel]))
  
  }

  # Calculate 95% CI
  aggSim_and_Data <- merge(
    aggSim[,.(missedHigh=quantile(aggMissed,.975),
              missedLow=quantile(aggMissed,.025),
              falseAlarmHigh=quantile(aggFalseAlarms,.975),
              falseAlarmLow=quantile(aggFalseAlarms,.025),
              warningsHigh=quantile(aggWarnings,.975),
              warningsLow=quantile(aggWarnings,.025)),by=fragLabel],
    aggData,
    "fragLabel")

  # Organize results
  finalRec <- merge(aggSim_and_Data,agg,by="fragLabel")[
    ,.(`Fragment Size`=fragLabel,
       `Days to TCA`=TCA_Bin,
       `Warn Threshold`=WarnThreshold),by=fragLabel]
  
  finalRec <- finalRec[,!"fragLabel"]
  
  finalPerformance <- aggSim_and_Data[,.(
    `Fragment Size`=fragLabel,
    `Missed`=paste0(aggMissed," [",missedLow," - ",missedHigh,"]"),
    `False Alarms`=paste0(aggFalseAlarms," [",falseAlarmLow," - ",falseAlarmHigh,"]"),
    `Warnings`=paste0(aggWarnings," [",warningsLow," - ",warningsHigh,"]")
  )]
  
  # Plot 
  final <- 
  aggSim_and_Data %>%
      plot_ly(
      type="scatter",
      mode="markers",
      x=~aggFalseAlarms,
      y=~aggMissed,
      marker=list(size=15,
                  line=list(color="#FFFFFF",
                            width=3.25)),
      color=~fragLabel,
      colors=c("blue","dodgerblue","gray"),
      marker=list(size=12),
      hoverinfo="text",
      text=~paste("<b>Total Missed:</b> ",aggMissed,"<br>",
                  "<b>95% CI:</b> [",round(missedLow)," - ",round(missedHigh),"]<br><br>", 
                  "<b>Total False Alarms:</b> ",aggFalseAlarms,"<br>",
                  "<b>95% CI:</b> [",round(falseAlarmLow)," - ",round(falseAlarmHigh),"]<br><br>", 
                  "<b>Total Warnings:</b>",aggWarnings,"<br>",
                  "<b>95% CI:</b> [",round(warningsLow)," - ",round(warningsHigh),"]")
    ) %>%
    
    layout(
      shapes=list(
        list(
          type="rect",
          fillcolor = "blue", line=list(color="#FFFFFF"),opacity = 0.3,
          x0 = aggSim_and_Data[fragLabel==">= 1",falseAlarmLow], 
          x1 = aggSim_and_Data[fragLabel==">= 1",falseAlarmHigh], xref = "x",
          y0 = aggSim_and_Data[fragLabel==">= 1",missedLow], 
          y1 = aggSim_and_Data[fragLabel==">= 1",missedHigh], yref = "y"),
        list(
          type="rect",
          fillcolor = "dodgerblue",line=list(color="#FFFFFF"),opacity = 0.3,
          x0 = aggSim_and_Data[fragLabel==">= 10",falseAlarmLow], 
          x1 = aggSim_and_Data[fragLabel==">= 10",falseAlarmHigh], xref = "x",
          y0 = aggSim_and_Data[fragLabel==">= 10",missedLow], 
          y1 = aggSim_and_Data[fragLabel==">= 10",missedHigh], yref = "y"),
        list(
          type="rect",
          fillcolor = "gray", line=list(color="#FFFFFF"),opacity = 0.3,
          x0 = aggSim_and_Data[fragLabel==">= 100",falseAlarmLow], 
          x1 = aggSim_and_Data[fragLabel==">= 100",falseAlarmHigh], xref = "x",
          y0 = aggSim_and_Data[fragLabel==">= 100",missedLow], 
          y1 = aggSim_and_Data[fragLabel==">= 100",missedHigh], yref = "y")
      ),
      legend = list(title = list(text="<b>Fragment Size</b>")),
      xaxis = list(title="<b>False Alarms (FP)</b>",
                   gridcolor="#333333"),
      yaxis = list(title="<b>Missed Concern Events (FN)</b>",
                   gridcolor="#333333",
                   zeroline = TRUE,
                   zerolinecolor="#333333"),
      plot_bgcolor  = "#444444",
      paper_bgcolor = "#444444",
      font = list(color = '#FFFFFF')
    ) %>% plotly_build()
  
  return(list("plot"=final,
              "finalRec"=finalRec,
              "finalPerformance"=finalPerformance))
}

final <- evalPerformance()

# Save and push to Git
concernCount_5_plot <- concernCount_5$plot %>% plotly_build()
concernCount_4_plot <- concernCount_4$plot %>% plotly_build()
concernCount_3_plot <- concernCount_3$plot %>% plotly_build()

save(concernCount_5_plot,
     concernCount_4_plot,
     concernCount_3_plot,
     final,
     file="products/finalPlots.RData")



# Plot Pc collision differences between 5 and 1 ####
debrisData <- merge(
  concernSummary_at_TOI[TCA_Bin %in% c(5,4,3),c("eventNumber","Pc_at_TOI","fragNum","TCA_Bin")],
  concernSummary[,c("eventNumber","Pc_min","fragNum")],
  by=c("eventNumber","fragNum")
)

fragLabel <- case_when(
  debrisData[,fragNum] == "PcBest" ~ ">= 1",
  debrisData[,fragNum] == "PcFrag10" ~ ">= 10",
  debrisData[,fragNum] == "PcFrag100" ~ ">= 100"
)
debrisData[,"FragLabel" := fragLabel]
debrisData[,"TCA_Bin" := factor(TCA_Bin,levels=c("3","4","5"))]

debrisData[,"delta" := Pc_min - Pc_at_TOI]

Pc_delta <- 
  debrisData %>%
  plot_ly(
    type="histogram",
    x=~delta,
    color=~TCA_Bin,
    nbinsx=20,
    colors=c("blue","dodgerblue","gray")
  ) %>%
  layout(xaxis = list(title="<b>Collision Probability Delta\nOver time</b>",
                      gridcolor="#333333",
                      tickvals=seq(-600*1e-6,400*1e-6,200*1e-6),
                      ticktext=seq(-600*1e-6,400*1e-6,200*1e-6) %>% 
                        formatC(format="e",digits=0)),
         
         yaxis = list(title="<b>Frequency</b>",
                      gridcolor="#333333",
                      type = "log"),
         legend = list(title = list(text = "<b>Days to TCA</b>")),
         plot_bgcolor  = "#444444",
         paper_bgcolor = "#444444",
         font = list(color = '#FFFFFF')
  ) %>% plotly_build()

save(Pc_delta,file="products/Pc_delta.RData")


