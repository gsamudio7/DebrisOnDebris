# Imports ####

library(data.table)
library(dplyr)
library(plotly)
library(RColorBrewer)

load("data/concernData.RData")

# How does quantity change over time ####
concernSummary_at_TOI[fragNum=="PcBest" & Pc_at_TOI >= 1e-5,.N,by=TCA_Bin] %>% 
  plot_ly(
    type="bar",
    x=~TCA_Bin,
    y=~N,
    color=I("royalblue4")
  )




# How does quantity of NEW concern events change over time
concernEvents <- concernSummary_at_TOI[fragNum=="PcBest" & Pc_at_TOI >= 1e-5]

newConcernEvents <- list("10"=concernEvents[TCA_Bin==10,unique(eventNumber)])
for (i in (9:1)) {
  oldEvents <- concernEvents[TCA_Bin==i + 1,unique(eventNumber)] 
  newEvents <- concernEvents[TCA_Bin==i,unique(eventNumber)] 
  newConcernEvents[[as.character(i)]] = setdiff(newEvents,oldEvents)
}
newConcernSummary <- merge(
  data.table("TCA_Bin"=as.factor(10:1),
             "newCount"=unlist(lapply(newConcernEvents,length))),
  concernEvents[,.(concernCount=.N),by=TCA_Bin],
  by="TCA_Bin"
) 

newConcernSummary_plot <- newConcernSummary %>% 
  plot_ly(
    type="bar",
    x=~TCA_Bin,
    y=~concernCount,
    color=I("#222222"),
    name="Total",
    hoverinfo="none"
  ) %>%
  
  add_trace(
    y=~newCount,
    name="New",
    color=I("#2359c4")
  ) %>%
  
  layout(
    xaxis=list(title="<b>Days to TCA Bin</b>",
               gridcolor="#333333"),
    yaxis=list(title="<b>Concern Events</b>",
               gridcolor="#333333"),
    plot_bgcolor  = "#444444",
    paper_bgcolor = "#444444",
    font = list(color = '#FFFFFF')
  )



save(newConcernSummary_plot,file="products/newConcernSummary_plot.RData")


# Count the number of new events plus events that are carried through
'%ni%' <- Negate('%in%')
events_at_5 <- concernSummary_at_TOI[TCA_Bin==5,unique(eventNumber)]
length(events_at_5)
events_at_5_and_1 <- concernSummary_at_TOI[eventNumber %in% events_at_5 & TCA_Bin==1,unique(eventNumber)]
length(events_at_5_and_1)
events_at_1_and_not_at_5 <- concernSummary_at_TOI[eventNumber %ni% events_at_5 & TCA_Bin==1,
                                                  unique(eventNumber)]
length(events_at_1_and_not_at_5)
events_at_5_and_not_at_1 <- setdiff(events_at_5,concernSummary[,unique(eventNumber)])

# Verify
length(events_at_5_and_1) + length(events_at_1_and_not_at_5) == concernSummary_at_TOI[TCA_Bin==1,uniqueN(eventNumber)]

# Wrangle data to show
## event PC at 5 / PC at 1 / makes it through (Y/N)
deltaSummary <- rbindlist(list(
  concernSummary_at_TOI[eventNumber %in% events_at_5_and_1 &
                          fragNum=="PcBest" &
                          TCA_Bin==5, .(eventNumber,TCA_Bin,Pc=Pc_at_TOI,Censored=FALSE)],
  concernSummary[eventNumber %in% events_at_5_and_1 &
                   fragNum=="PcBest", .(eventNumber,TCA_Bin=1,Pc=Pc_min,Censored=FALSE)],
  concernSummary_at_TOI[eventNumber %in% events_at_5_and_not_at_1 &
                          fragNum=="PcBest" &
                          TCA_Bin==5, .(eventNumber,TCA_Bin,Pc=Pc_at_TOI,Censored=TRUE)],
  data.table("eventNumber"=events_at_5_and_not_at_1,
             "TCA_Bin"=1,
             "Pc"=0,
             "Censored"=TRUE)
))
setorder(deltaSummary,-"TCA_Bin")
delta_plot_summary <- deltaSummary[,.(delta=diff(Pc)),by=c("eventNumber","Censored")] 



delta_plot_summary[,"Delta" := ifelse(delta > 0, "> 0",
                                      ifelse(delta == 0, "= 0","< 0"))]


deltaCountSummary <- merge(
  data.table("Total"=c(delta_plot_summary[Censored==TRUE,.N],
                       delta_plot_summary[Censored==FALSE,.N]),
             "Censored"=c(TRUE,FALSE)
  ),
  
  delta_plot_summary[,.(Count=.N),by=c("Censored","Delta")],
  by="Censored"
)
deltaCountSummary[,"Proportion" := round(Count/Total,3)]
deltaCountSummary[,!"Total"]

delta_plot_summary %>%
  plot_ly(
    type="histogram",
    x=~delta,
    nbinsx=10,
    color=~Censored
  ) %>%
  layout(
    xaxis = list(title="<b>Collision Probability Delta\nat 5 and 1 days to TCA</b>",
                 tickvals = seq(-700,0,100),
                 ticktext = seq(-700,0,100) %>% exp() %>% formatC(format="e",digits=2),
                 tickfont = list(size = 10),
                 gridcolor="#333333"))


# What is the distribution of Pc at 5 for events that make it to 1
concernSummary_at_TOI[fragNum=="PcBest" & 
                        eventNumber %in% events_at_5_and_1 & 
                        TCA_Bin == 5 |
                        
                        fragNum=="PcBest" & 
                        eventNumber %in% events_at_5_and_1 & 
                        TCA_Bin == 1] %>%
  plot_ly(
    type="box",
    x=~TCA_Bin,
    y=~log(Pc_at_TOI)
  ) 

# What is the distribution of the delta?
concernSummary_Pc_at_1_from_5 <- concernSummary_at_TOI[
  fragNum=="PcBest" & 
    eventNumber %in% events_at_5_and_1 & 
    TCA_Bin == 1 |
    
    fragNum=="PcBest" & 
    eventNumber %in% events_at_5_and_1 & 
    TCA_Bin == 5] %>% setorder(eventNumber,-TCA_Bin)

concernSummary_diff_at_1_from_5 <- concernSummary_Pc_at_1_from_5[
  ,.(Delta=diff(Pc_at_TOI)),by=eventNumber] 

# How many 0
concernSummary_diff_at_1_from_5[Delta==0,.N]/concernSummary_diff_at_1_from_5[,.N] # 0.64

# How many increased
concernSummary_diff_at_1_from_5[Delta > 0,.N]/concernSummary_diff_at_1_from_5[,.N] # 0.085

# How many decreased
concernSummary_diff_at_1_from_5[Delta < 0,.N]/concernSummary_diff_at_1_from_5[,.N] 

# Box Plot
concernSummary_Pc_at_1_from_5 %>%
  plot_ly(
    type="box",
    y=~log(Pc_at_TOI),
    x=~as.integer(TCA_Bin) - 1
  ) %>%
  layout(
    yaxis = list(title="<b>Probability of Collision</b>",
                 tickvals = seq(-700,0,100),
                 ticktext = seq(-700,0,100) %>% exp() %>% formatC(format="e",digits=2),
                 tickfont = list(size = 10)),
    xaxis = list(title="<b>Days to TCA</b>")
  )

concernSummary_Pc_at_1_from_5 %>%
  plot_ly(
    type="scatter",
    mode="lines",
    y=~log(Pc_at_TOI),
    x=~as.integer(TCA_Bin) - 1
  ) 

# Conclusion
## No obvious advantage in having a higher Pc_warn threshold at 5 days than the Pc_concern rate

# Question remains, what Pc_warn value at 5 days is the ideal to use to 
## minimize False negatives and minimize False Positives




# Plot
Pc_by_TCA_plot <- 
  
concernSummary_at_TOI[fragNum=="PcBest"] %>%
  plot_ly(
    type="box",
    y=~log(Pc_at_TOI),
    x=~TCA_Bin,
    hoverinfo="none",
    color=I("#2359c4")
  ) %>%
  layout(
    yaxis = list(title="<b>Collision Probability</b>",
                 tickvals = seq(-30,-6,2),
                 ticktext = seq(-30,-6,2) %>% exp() %>% formatC(format="e",digits=2),
                 tickfont = list(size = 10),
                 gridcolor="#333333"),
    xaxis = list(title="<b>Days to TCA</b>",
                 gridcolor="#333333"),
    plot_bgcolor  = "#444444",
    paper_bgcolor = "#444444",
    font = list(color = '#FFFFFF')
  )

save(Pc_by_TCA_plot,file="products/Pc_by_TCA_plot.RData")



# Count total positives (events of concern) that we have visibility on at 5 days out
Pc_concern <- 1e-5
(P_at_5 <- concernSummary_at_TOI[TCA_Bin==5 & PcBest_at_TOI >= Pc_concern,.N]) # 21
(N_at_5 <- concernSummary_at_TOI[TCA_Bin==5 & PcBest_at_TOI < Pc_concern,.N]) # 29323

(P <- concernSummary[fragNum=="PcBest" & Pc_min >= Pc_concern,.N]) # 58
(N <- concernSummary[fragNum=="PcBest" & Pc_min < Pc_concern,.N]) # 48193



# Monte Carlo Bitches! ####

# Imports for plot ####
rm(list=ls())
library(data.table)
library(dplyr)
library(plotly)
library(RColorBrewer)

# Loads two data sets, concernSummary and concernSummary_at_TOI (time of interest)
load("data/debrisData.RData")
events <- fread("data/events.csv")
(scale <- 365/events[,uniqueN(round(time_of_screening))])

# Debris Confusion Function ####
debrisConfusion <- function(df,
                            Pc_warn,
                            Pc_concern=1e-5,
                            fragVector=debrisData[,unique(fragLabel)],
                            verbose=FALSE
) {
  
  # Initiate result list
  result <- list()
  
  # Loop over frag numbers
  for (frag in fragVector) {
    
    # Count missed events (FN) and false alarms (FP) and warnings
    # Accumulate in a data.table
    result[[paste0(frag)]] <- data.table(
      "WarnThreshold"=Pc_warn %>% formatC(format="e",digits=2),
      "Missed"=df[fragLabel==frag & Pc_at_TOI < Pc_warn & Pc_min >= Pc_concern,.N],
      "FalseAlarms"=df[fragLabel==frag & Pc_at_TOI >= Pc_warn & Pc_min < Pc_concern,.N],
      "WarningCount"=df[fragLabel==frag & Pc_at_TOI >= Pc_warn,.N],
      "fragLabel"=frag,
      "TCA_Bin"=df[,unique(TCA_Bin)]
    )
  }
  return(rbindlist(result))
}

# Trade off plot function
trade_off_plot <- function(tcaBins=c(5),
                           test_thresholds=c(seq(from=1e-8,to=1e-5,by=1e-7),1e-5),
                           runMonte=FALSE,
                           numSamples=NULL) {
  
  # Compute point estimate
  cat("\nComputing point estimates")
  concernCount <- purrr::map(
    test_thresholds,
    debrisConfusion,
    df=debrisData[TCA_Bin %in% tcaBins]) %>% rbindlist() 
  
  # Compute optimal thresholds 
  cat("\nComputing optimal thresholds")
  optimal_thresholds <- lapply(
    concernCount[,unique(fragLabel)],
    function(x) {concernCount[fragLabel==x][which.min(Missed + FalseAlarms),
                                            c("WarnThreshold","Missed","FalseAlarms",
                                              "fragLabel","WarningCount")]}
  ) %>% rbindlist()
  
  # Monte Carlo
  if (runMonte==TRUE) {
    cat("\nSampling")
    debrisResult <- list()
    for (i in 1:numSamples) {
    
      # Sample the data
      sampleDebris <- debrisData[TCA_Bin %in% tcaBins][
        sample(.N,nrow(debrisData[TCA_Bin %in% tcaBins]),replace=TRUE)]  
    
      # Store results
      debrisResult[[i]] <- purrr::map(
        test_thresholds,
        debrisConfusion,
        df=sampleDebris) %>% rbindlist() 
  }
  
      # Get the 95% CI for FalseAlarms and Missed
      mcResult <- debrisResult %>% rbindlist()
      mcResult <- mcResult[,.(FalseAlarmHigh=quantile(FalseAlarms,.975),
                              FalseAlarmLow=quantile(FalseAlarms,.025),
                              MissedHigh=quantile(Missed,.975),
                              MissedLow=quantile(Missed,.025)),by=c("WarnThreshold",
                                                                    "fragLabel")]
  
      # Label the warning, false alarm, and missed count columns
      mcResult <- mcResult %>% 
        cbind(concernCount[,c("WarningCount","Missed","FalseAlarms")])
  }
  
  # FP against FN plot ####
  cat("\nPlotting\n")
  trade_off <- 
    concernCount %>% 
      plot_ly(type="scatter",
              mode="lines",
              x=~FalseAlarms*scale,
              y=~Missed*scale,
              color=~fragLabel,
              legendgroup=~fragLabel,
              text=~paste0("<b>Warning Threshold: </b>",WarnThreshold,"<br>",
                           "<b>Warning Count: </b>",round(WarningCount*scale),"<br>",
                           "<b>Missed: </b>",round(Missed*scale),"<br>",
                           "<b>False Alarms: </b>",round(FalseAlarms*scale),"<br>"),
              hoverinfo="text",
              colors=c("blue","dodgerblue","gray"),
              line=list(width=3.25)
      ) %>%
      
      layout(
        legend = list(title = list(text="<b>Fragment Size</b>")),
        xaxis = list(title="<b>False Alarms (FP)</b>",
                     gridcolor="#333333"),
        yaxis = list(title="<b>Missed Concern Events (FN)</b>",
                     gridcolor="#333333",
                     zeroline = TRUE,
                     zerolinecolor="#333333"),
        plot_bgcolor  = "#444444",
        paper_bgcolor = "#444444",
        font = list(color = '#FFFFFF')
      ) %>%
      
      add_trace(
        data=optimal_thresholds,
        type="scatter",
        mode="markers",
        marker=list(size=15,
                    color="#444444",
                    line=list(color="mediumspringgreen",
                              width=3.25)),
        x=~FalseAlarms*scale,
        y=~Missed*scale,
        color=optimal_thresholds,
        name="Optimal Warning",
        showlegend=TRUE
      )
  
  if (runMonte==FALSE) {return(
    list("plot"=trade_off %>% plotly_build(),
         "optThresholds"=optimal_thresholds))} else {
           
      trade_off <- 
      trade_off %>%
      add_trace(
        data=mcResult,
        type="scatter",
        mode="lines",
        line=list(dash=3,width=2),
        x=~FalseAlarmHigh*scale,
        y=~MissedHigh*scale,
        color=~fragLabel,
        legendgroup=~fragLabel,
        colors=c("blue","dodgerblue","gray"),
        showlegend=FALSE
      ) %>% 
      
      add_trace(
        data=mcResult,
        type="scatter",
        mode="lines",
        line=list(dash=3,width=2),
        x=~FalseAlarmLow*scale,
        y=~MissedLow*scale,
        color=~fragLabel,
        legendgroup=~fragLabel,
        colors=c("#2359c4","dodgerblue","gray"),
        showlegend=FALSE
      ) %>% plotly_build()
      
      return(
        list("plot"=trade_off,
             "optThresholds"=optimal_thresholds))}
}

# Find the optimal warningThreshold for 5 days to TCA
concernCount_5 <- trade_off_plot()
concernCount_4 <- trade_off_plot(tcaBins=c(4))
concernCount_3 <- trade_off_plot(tcaBins=c(3))

# Aggregate point estimates over 3,4,5
agg <- rbindlist(list(
  concernCount_5$optThresholds,
  concernCount_4$optThresholds,
  concernCount_3$optThresholds
))
aggData <- agg[,.(aggMissed=sum(Missed),
                  aggFalseAlarms=sum(FalseAlarms)),by=fragLabel]

# Run monte carlo using the optimal thresholds
aggSim <- data.table()
for (i in 1:1000) {
  
  # Sample and compute false alarm and missed with optimal warning thresholds 
  aggMonte <- rbindlist(list(
    lapply(1:3,function(i) {
      debrisConfusion(
        df=debrisData[TCA_Bin == 5][sample(.N,nrow(debrisData[TCA_Bin == 5]),replace=TRUE)],
        Pc_warn=concernCount_5$optThresholds$WarnThreshold[i] %>% as.numeric(),
        fragVector=concernCount_5$optThresholds$fragLabel[i])
    }) %>% rbindlist(),
    
    lapply(1:3,function(i) {
      debrisConfusion(
        df=debrisData[TCA_Bin == 4][sample(.N,nrow(debrisData[TCA_Bin == 4]),replace=TRUE)],
        Pc_warn=concernCount_4$optThresholds$WarnThreshold[i] %>% as.numeric(),
        fragVector=concernCount_4$optThresholds$fragLabel[i])
    }) %>% rbindlist(),
    
    lapply(1:3,function(i) {
      debrisConfusion(
        df=debrisData[TCA_Bin == 3][sample(.N,nrow(debrisData[TCA_Bin == 3]),replace=TRUE)],
        Pc_warn=concernCount_3$optThresholds$WarnThreshold[i] %>% as.numeric(),
        fragVector=concernCount_3$optThresholds$fragLabel[i])
    }) %>% rbindlist()
  ))

  aggSim <- rbindlist(list(aggSim,
    aggMonte[,.(aggMissed=sum(Missed),
                aggFalseAlarms=sum(FalseAlarms)),by=fragLabel]))
  
}

aggSim_and_Data <- merge(
  aggSim[,.(missedHigh=quantile(aggMissed,.975),
            missedLow=quantile(aggMissed,.025),
            falseAlarmHigh=quantile(aggFalseAlarms,.975),
            falseAlarmLow=quantile(aggFalseAlarms,.025)),by=fragLabel],
  aggData,
  "fragLabel")

# Plot 
final <- 
aggSim_and_Data %>%
  plot_ly(
    type="scatter",
    mode="markers",
    x=~aggFalseAlarms,
    y=~aggMissed,
    marker=list(size=15,
                line=list(color="#FFFFFF",
                          width=3.25)),
    color=~fragLabel,
    colors=c("blue","dodgerblue","gray"),
    marker=list(size=12)
  ) %>%
  
  layout(
    shapes=list(
      list(
        type="rect",
        fillcolor = "blue", line=list(color="#FFFFFF"),opacity = 0.3,
        x0 = aggSim_and_Data[fragLabel==">= 1",falseAlarmLow], 
        x1 = aggSim_and_Data[fragLabel==">= 1",falseAlarmHigh], xref = "x",
        y0 = aggSim_and_Data[fragLabel==">= 1",missedLow], 
        y1 = aggSim_and_Data[fragLabel==">= 1",missedHigh], yref = "y"),
      list(
        type="rect",
        fillcolor = "dodgerblue",line=list(color="#FFFFFF"),opacity = 0.3,
        x0 = aggSim_and_Data[fragLabel==">= 10",falseAlarmLow], 
        x1 = aggSim_and_Data[fragLabel==">= 10",falseAlarmHigh], xref = "x",
        y0 = aggSim_and_Data[fragLabel==">= 10",missedLow], 
        y1 = aggSim_and_Data[fragLabel==">= 10",missedHigh], yref = "y"),
      list(
        type="rect",
        fillcolor = "gray", line=list(color="#FFFFFF"),opacity = 0.3,
        x0 = aggSim_and_Data[fragLabel==">= 100",falseAlarmLow], 
        x1 = aggSim_and_Data[fragLabel==">= 100",falseAlarmHigh], xref = "x",
        y0 = aggSim_and_Data[fragLabel==">= 100",missedLow], 
        y1 = aggSim_and_Data[fragLabel==">= 100",missedHigh], yref = "y")
    ),
    legend = list(title = list(text="<b>Fragment Size</b>")),
    xaxis = list(title="<b>False Alarms (FP)</b>",
                 gridcolor="#333333"),
    yaxis = list(title="<b>Missed Concern Events (FN)</b>",
                 gridcolor="#333333",
                 zeroline = TRUE,
                 zerolinecolor="#333333"),
    plot_bgcolor  = "#444444",
    paper_bgcolor = "#444444",
    font = list(color = '#FFFFFF')
  ) %>% plotly_build()

# Save and push to Git
concernCount_5_plot <- concernCount_5$plot %>% plotly_build()
concernCount_4_plot <- concernCount_4$plot %>% plotly_build()
concernCount_3_plot <- concernCount_3$plot %>% plotly_build()

save(concernCount_5_plot,
     concernCount_4_plot,
     concernCount_3_plot,
     final,
     file="products/finalPlots.RData")





# Execute functions
concernCount_5 <- trade_off_plot(tcaBins=c(5))
concernCount_5_and_4 <- trade_off_plot(tcaBins=c(5,4))
concernCount_5_and_4_and_3 <- trade_off_plot(tcaBins=c(5,4,3))
gc()
concernCount_3 <- trade_off_plot(tcaBins=c(3))
concernCount_4 <- trade_off_plot(tcaBins=c(4))
concernCount_2 <- trade_off_plot(tcaBins=c(2))

save(concernCount_5,
     concernCount_5_and_4,
     concernCount_5_and_4_and_3,
     concernCount_3,concernCount_4,concernCount_2,
     file="products/concernCount_plots.RData")


# Plot Pc collision differences between 5 and 1 ####
debrisData <- merge(
  concernSummary_at_TOI[TCA_Bin %in% c(5,4,3),c("eventNumber","Pc_at_TOI","fragNum","TCA_Bin")],
  concernSummary[,c("eventNumber","Pc_min","fragNum")],
  by=c("eventNumber","fragNum")
)

fragLabel <- case_when(
  debrisData[,fragNum] == "PcBest" ~ ">= 1",
  debrisData[,fragNum] == "PcFrag10" ~ ">= 10",
  debrisData[,fragNum] == "PcFrag100" ~ ">= 100"
)
debrisData[,"FragLabel" := fragLabel]
debrisData[,"TCA_Bin" := factor(TCA_Bin,levels=c("3","4","5"))]

debrisData[,"delta" := Pc_min - Pc_at_TOI]

Pc_delta <- 
  debrisData %>%
  plot_ly(
    type="histogram",
    x=~delta,
    color=~TCA_Bin,
    nbinsx=20,
    colors=c("blue","dodgerblue","gray")
  ) %>%
  layout(xaxis = list(title="<b>Collision Probability Delta\nOver time</b>",
                      gridcolor="#333333",
                      tickvals=seq(-600*1e-6,400*1e-6,200*1e-6),
                      ticktext=seq(-600*1e-6,400*1e-6,200*1e-6) %>% 
                        formatC(format="e",digits=0)),
         
         yaxis = list(title="<b>Frequency</b>",
                      gridcolor="#333333",
                      type = "log"),
         legend = list(title = list(text = "<b>Days to TCA</b>")),
         plot_bgcolor  = "#444444",
         paper_bgcolor = "#444444",
         font = list(color = '#FFFFFF')
  ) %>% plotly_build()

save(Pc_delta,file="products/Pc_delta.RData")







# Function Demo ####

# Test 
rm(list=ls())

# Read in required data 
load("data/concernData.RData")

# Read in debrisCounfuction function
source("scripts/debrisConfusion.R")

# Execute function for the following inputs
results <- debrisConfusion(concernData_at_TOI=concernSummary_at_TOI,
                           concernData=concernSummary,
                           Pc_warn=2.06e-9,
                           days_to_TCA=5,
                           Pc_concern=1e-5,
                           frag_number_Pc="PcBest",
                           verbose=FALSE,
                           rate=FALSE)
